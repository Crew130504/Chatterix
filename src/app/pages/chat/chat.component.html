<div class="chat-container">
  <!-- Cabecera general -->
  <div class="chat-header">
    <h5>Bienvenido, {{ usuario.NOMBRE }} {{ usuario.APELLIDO }}</h5>
    <span class="text-muted">
      {{ fechaActual | date:'fullDate' }} ‚Äì {{ horaActual | date:'shortTime' }}
    </span>
  </div>

  <div class="chat-body">
    <!-- Sidebar: conversaciones -->
    <div class="sidebar">
      <h6>Conversaciones</h6>
      <div
        *ngFor="let chat of conversacionesOrdenadas"
        class="chat-item"
        (click)="abrirConversacion(chat)"
      >
        <div class="chat-item-header">
          <strong>{{ chat.nombre }}</strong>
          <small class="text-muted">
            {{ chat.ultimahora ? humanizeConversationDate(chat.ultimahora) : '---' }}
          </small>
        </div>
        <div class="chat-item-preview text-muted">
          <ng-container *ngIf="chat.ultimomensaje; else archivoOvacio">
            {{ chat.ultimomensaje }}
          </ng-container>

          <ng-template #archivoOvacio>
            <ng-container *ngIf="chat.ultimotipocontenido === '1'; else sinMensajes">
              üìé {{ chat.ultimotipoarchivo }}
            </ng-container>
          </ng-template>

          <ng-template #sinMensajes>
            Sin mensajes a√∫n
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Contenido del chat seleccionado -->
    <div class="chat-content">
      <p *ngIf="!chatActivo">Selecciona una conversaci√≥n</p>
      <div *ngIf="chatActivo" class="chat-box">
        <!-- T√≠tulo del chat -->
        <div class="chat-header-active">
          <strong>{{ chatActivo.nombre }}</strong>
        </div>

        <!-- Mensajes con separadores de fecha -->
        <div #chatMessages class="chat-messages">
          <ng-container *ngFor="let msg of chatActivo.mensajes; let i = index">
            <!-- separador cuando cambia el d√≠a -->
            <div
              *ngIf="i === 0 || !isSameDay(msg.fecha, chatActivo.mensajes[i - 1].fecha)"
              class="date-separator"
            >
              {{ humanizeDate(msg.fecha) }}
            </div>

            <!-- burbuja de mensaje con respuesta -->
            <div
              [ngClass]="{
                'mensaje-wrapper': true,
                derecha: msg.propio,
                izquierda: !msg.propio
              }"
            >
              <div
                class="mensaje"
                [class.propietario]="msg.propio"
                (contextmenu)="abrirMenuContextual($event, msg)"
              >
                <!-- remitente si es grupo -->
                <ng-container *ngIf="chatActivo.tipo === 'grupo' && !msg.propio">
                  <div class="cabecera">
                    <small>{{ msg.remitente }}</small>
                  </div>
                </ng-container>

                <!-- Vista del mensaje original si es respuesta -->
                <div *ngIf="msg.respuestaDe" class="respuesta-preview">
                  <small class="text-muted">
                    {{ msg.respuestaDe.autor }}:
                    ‚Äú{{ msg.respuestaDe.texto.length > 50
                      ? (msg.respuestaDe.texto | slice: 0: 50) + '...'
                      : msg.respuestaDe.texto }}‚Äù
                  </small>
                </div>

              <div class="contenido-con-meta">
                <!-- si no es archivo, mostramos el texto -->
                <ng-container *ngIf="!msg.esArchivo; else archivoTpl">
                  <span class="contenido-texto">{{ msg.contenido }}</span>
                </ng-container>

                <!-- si es archivo, mostramos enlace -->
                <ng-template #archivoTpl>
                  <a
                    [href]="msg.archivoUrl"
                    target="_blank"
                    class="archivo-link"
                  >
                    üìé {{ msg.idTipoArchivo || 'Descargar archivo' }}
                  </a>
                </ng-template>

                <!-- hora siempre -->
                <span class="meta">{{ msg.fecha | date:'shortTime' }}</span>
              </div>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Vista previa de mensaje a responder -->
        <div *ngIf="mensajeSeleccionado" class="respuesta-activa">
          <span class="text-muted">
            Respondiendo a: "{{ mensajeSeleccionado.contenido }}"
          </span>
          <button (click)="cancelarRespuesta()" class="btn-cancelar">‚úñ</button>
        </div>

        <!-- input para nuevo mensaje + carga de archivo -->
        <div class="mensaje-input">
          <textarea
            [(ngModel)]="nuevoMensaje"
            placeholder="Escribe un mensaje..."
            rows="2"
          ></textarea>

          <!-- selector de archivo -->
          <input
            type="file"
            (change)="onFileChange($event)"
          />

          <!-- vista previa del archivo seleccionado -->
          <div *ngIf="selectedFile" class="file-preview">
            <small>{{ selectedFile.name }}</small>
            <button
              type="button"
              (click)="selectedFile = null"
              title="Eliminar archivo"
              class="btn-cancelar-file"
            >
              ‚úñ
            </button>
          </div>

          <button (click)="enviarMensaje()">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>
